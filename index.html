<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HidroFlow - Painel de Irrigação</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --success-color: #28a745;
      --success-hover-color: #1e7e34;
      --danger-color: #dc3545;
      --danger-hover-color: #b02a37;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --neutral-color: #6c757d;
      --neutral-hover-color: #545b62;
      --background-color: #f0f2f5;
      --card-background-color: #ffffff;
      --text-color: #333;
      --text-light-color: #555;
      --text-muted-color: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --box-shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.15);

      --font-size-xs: clamp(0.75rem, 0.4vw + 0.65rem, 0.85rem);
      /* Novo para textos menores */
      --font-size-sm: clamp(0.8rem, 0.5vw + 0.7rem, 0.95rem);
      /* Ligeiro aumento no max */
      --font-size-base: clamp(0.95rem, 0.8vw + 0.6rem, 1.1rem);
      /* Ajustado min para mobile */
      --font-size-md: clamp(1.1rem, 1vw + 0.6rem, 1.25rem);
      --font-size-lg: clamp(1.25rem, 1.2vw + 0.7rem, 1.75rem);
      --font-size-xl: clamp(1.7rem, 1.5vw + 0.9rem, 2.15rem);
      /* Ajustado para mobile */

      --spacing-xs: clamp(5px, 1vw, 8px);
      --spacing-sm: clamp(8px, 1.5vw, 12px);
      /* Ajustado para mobile */
      --spacing-md: clamp(12px, 2.5vw, 18px);
      /* Ajustado para mobile */
      --spacing-lg: clamp(18px, 3.5vw, 28px);
      /* Ajustado */
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Open Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: var(--spacing-sm);
    }

    .auth-container {
      background-color: var(--card-background-color);
      padding: var(--spacing-md) var(--spacing-lg);
      /* Padding horizontal maior */
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      width: 100%;
      max-width: 380px;
      /* Levemente reduzido para telas muito pequenas */
    }

    .auth-container h2 {
      color: var(--primary-color);
      margin-bottom: var(--spacing-md);
      font-family: 'Roboto', sans-serif;
      font-size: var(--font-size-lg);
    }

    .auth-options button,
    .password-form button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-base);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
      margin-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
    }

    .auth-options button:hover,
    .password-form button:hover {
      background-color: var(--primary-hover-color);
    }

    .auth-options button.guest-btn {
      background-color: var(--neutral-color);
    }

    .auth-options button.guest-btn:hover {
      background-color: var(--neutral-hover-color);
    }

    .password-form input[type="password"] {
      width: 100%;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
    }

    #authMessage {
      color: var(--danger-color);
      font-size: var(--font-size-sm);
      margin-top: var(--spacing-sm);
      min-height: 1.2em;
    }

    .container {
      margin-top: var(--spacing-md);
      margin-left: auto;
      margin-right: auto;
      background-color: var(--card-background-color);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
      max-width: 95vw;
      margin-bottom: var(--spacing-md);
    }

    .container-header {
      display: flex;
      justify-content: space-between;
      /* H1 no centro (com grow), Botão à direita */
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-sm);
      /* Espaço entre H1 e botão */
    }

    .container-header h1 {
      margin-bottom: 0;
      /* Removida margem inferior do H1 */
      text-align: center;
      flex-grow: 1;
      /* Permite que o H1 ocupe o espaço, ajudando na centralização */
      /* O H1 em si ainda é um flex container para o ícone */
    }

    #panelActionButton {
      position: absolute; 
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-xs);
      min-width: auto;
      flex-shrink: 0;
      top: 0px; 
      right: 5px; 
      z-index: 10;
    }

    /* Ícone do botão de ação */
    #panelActionButton .fas {
      margin-right: var(--spacing-xs);
    }


    h1 {
      /* Estilo geral do H1, usado pelo do container-header */
      color: var(--primary-color);
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      font-size: var(--font-size-xl);
      display: flex;
      /* Para alinhar ícone e texto */
      align-items: center;
      justify-content: center;
      /* Centraliza ícone e texto dentro do h1 */
      gap: var(--spacing-sm);
    }

    h1 .fas {
      font-size: var(--font-size-lg);
    }

    .connection-status-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    #mqttStatus,
    #espStatus {
      font-weight: 500;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius);
      text-align: center;
      font-size: var(--font-size-base);
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      flex: 1 1 auto;
      min-width: 200px;
      /* Min-width ajustado */
    }

    #mqttStatus.connected,
    #espStatus.esp-online {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }

    #mqttStatus.disconnected,
    #espStatus.esp-offline {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }

    #espStatus.esp-loading {
      background-color: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
    }

    .logoutButton {
        background-color: var(--danger-color);
        color: white;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-sm);
        margin-top: var(--spacing-md);
        float: right;
    }
    .logoutButton:hover {
        background-color: var(--danger-hover-color);
    }

    .guest-login-btn {
      background-color: var(--primary-color);
      color: white;
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-sm);
      margin-top: var(--spacing-md);
      float: right;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      width: 100%;
    }

    .main-content>div {
      width: 100%;
    }

    /* Filhos diretos ocupam 100% da largura na coluna */

    .section-title {
      font-family: 'Roboto', sans-serif;
      font-size: var(--font-size-md);
      color: var(--primary-color);
      margin-bottom: var(--spacing-sm);
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--primary-color);
      display: inline-block;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      /* Minmax ajustado para mobile */
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .status-item {
      background-color: var(--card-background-color);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      border-left: 5px solid var(--primary-color);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-left-color 0.3s ease;
    }

    .status-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow-hover);
    }

    .status-item-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .status-item-header .icon {
      font-size: var(--font-size-md);
      color: var(--primary-color);
      width: 25px;
      text-align: center;
      transition: color 0.3s ease;
    }

    .status-item-header strong {
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
      font-size: var(--font-size-base);
      color: var(--text-light-color);
      transition: color 0.3s ease;
    }

    .status-value {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--text-color);
      margin-left: calc(25px + var(--spacing-sm));
      word-break: break-word;
    }

    #soilMoistureCard .status-item-subsection {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-sm);
      margin-left: calc(25px + var(--spacing-sm));
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
    }

    #soilMoistureCard .icon-subsection {
      font-size: var(--font-size-base);
      color: var(--text-muted-color);
      transition: color 0.3s ease;
    }

    .status-item.pump-on {
      border-left-color: var(--success-color);
    }

    .status-item.pump-on .status-item-header .icon,
    .status-item.pump-on .status-item-header strong {
      color: var(--success-color);
    }

    .status-item.pump-off {
      border-left-color: var(--danger-color);
    }

    .status-item.pump-off .status-item-header .icon,
    .status-item.pump-off .status-item-header strong {
      color: var(--danger-color);
    }

    .status-item.pump-neutral {
      border-left-color: var(--neutral-color);
    }

    .status-item.pump-neutral .status-item-header .icon,
    .status-item.pump-neutral .status-item-header strong {
      color: var(--neutral-color);
    }

    .status-item.auto-mode-on {
      border-left-color: var(--success-color);
    }

    .status-item.auto-mode-on .status-item-header .icon,
    .status-item.auto-mode-on .status-item-header strong {
      color: var(--success-color);
    }

    .status-item.auto-mode-off {
      border-left-color: var(--danger-color);
    }

    .status-item.auto-mode-off .status-item-header .icon,
    .status-item.auto-mode-off .status-item-header strong {
      color: var(--danger-color);
    }

    .status-item.auto-mode-neutral {
      border-left-color: var(--neutral-color);
    }

    .status-item.auto-mode-neutral .status-item-header .icon,
    .status-item.auto-mode-neutral .status-item-header strong {
      color: var(--neutral-color);
    }

    .status-item.soil-dry {
      border-left-color: var(--warning-color);
    }

    .status-item.soil-dry .status-item-header .icon {
      color: var(--warning-color);
    }

    .status-item.soil-dry .icon-subsection {
      color: var(--warning-color);
    }

    .status-item.soil-humid {
      border-left-color: var(--primary-color);
    }

    .status-item.soil-humid .status-item-header .icon {
      color: var(--primary-color);
    }

    .status-item.soil-humid .icon-subsection {
      color: var(--primary-color);
    }

    .status-item.soil-wet {
      border-left-color: var(--info-color);
    }

    .status-item.soil-wet .status-item-header .icon {
      color: var(--info-color);
    }

    .status-item.soil-wet .icon-subsection {
      color: var(--info-color);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .control-group {
      background-color: var(--card-background-color);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .control-group h3 {
      font-family: 'Roboto', sans-serif;
      font-size: var(--font-size-md);
      color: var(--text-muted-color);
      margin-bottom: var(--spacing-md);
      font-weight: 500;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    button {
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      text-align: center;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      min-width: 130px;
      /* Ajustado min-width */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }

    button:active {
      transform: translateY(0px) scale(0.98);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    button.on {
      background-color: var(--success-color);
    }

    button.on:hover:not(:disabled) {
      background-color: var(--success-hover-color);
    }

    button.off {
      background-color: var(--danger-color);
    }

    button.off:hover:not(:disabled) {
      background-color: var(--danger-hover-color);
    }

    button.mode {
      background-color: var(--primary-color);
    }

    button.mode:hover:not(:disabled) {
      background-color: var(--primary-hover-color);
    }

    button:disabled {
      background-color: var(--neutral-color) !important;
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button.selected {
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 50%, transparent);
      filter: brightness(1.1);
    }

    button.inactive {
      background-color: var(--neutral-color) !important;
      opacity: 0.7;
    }

    button.inactive:hover {
      background-color: var(--neutral-color) !important;
      transform: none;
      box-shadow: none;
    }

    /* Media queries para responsividade do layout principal */
    @media (min-width: 768px) {

      /* Tablets */
      .container {
        max-width: 90vw;
        padding: var(--spacing-lg);
      }

      .status-grid {
        grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
      }

      .auth-container {
        padding: var(--spacing-lg);
      }

      #panelActionButton {
        font-size: var(--font-size-sm);
      }
    }

    @media (min-width: 1024px) {

      /* Desktops Pequenos / Tablets Grandes em Paisagem */
      .container {
        max-width: 85vw;
      }

      .main-content {
        flex-direction: row;
        align-items: flex-start;
      }

      .main-content>div:nth-child(1) {
        flex: 1.8;
      }

      /* Sensores */
      .main-content>div:nth-child(2) {
        /* Controles */
        flex: 1.2;
        position: sticky;
        top: var(--spacing-md);
        max-height: calc(100vh - var(--spacing-md) * 2 - 50px);
        /* Ajuste para altura da viewport */
        overflow-y: auto;
      }

      .status-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      /* Mais cards por linha se possível */
    }

    @media (min-width: 1400px) {

      /* Desktops Largos */
      .container {
        max-width: 1200px;
      }

      .status-grid {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
    }
  </style>
</head>

<body>
  <div id="authScreen" class="auth-container">
    <h2>Bem-vindo ao HidroFlow!</h2>
    <p style="margin-bottom: var(--spacing-md); font-size: var(--font-size-sm); color: var(--text-muted-color);">
      Selecione o modo de acesso:</p>
    <div class="auth-options">
      <button id="adminLoginBtn"><i class="fas fa-user-shield"></i> Acessar como Administrador</button>
      <button id="guestLoginBtn" class="guest-btn"><i class="fas fa-eye"></i> Acessar como Visitante</button>
    </div>
    <div class="password-form" style="display: none; margin-top: var(--spacing-md);">
      <input type="password" id="passwordInput" placeholder="Digite a senha do administrador">
      <button id="submitPasswordBtn"><i class="fas fa-key"></i> Validar Senha</button>
    </div>
    <p id="authMessage"></p>
  </div>
  

  <div class="container" style="display: none;">
    <button id="panelActionButton" style="display: none;"></button>
    <div class="container-header">
      <h1><i class="fas fa-seedling"></i>HidroFlow <!-- <span style="font-weight: 300; color: var(--text-light-color);">-
          Painel de Irrigação</span> --> </h1>
      <!-- <button id="panelActionButton" style="display: none;"></button> -->
    </div>
    
    <div class="connection-status-container">
      <div id="mqttStatus" class="disconnected"><i class="fas fa-wifi"></i><span>Desconectado do Broker MQTT</span>
      </div>
      <div id="espStatus" class="esp-loading"><i class="fas fa-microchip"></i><span>Aguardando status do ESP32...</span>
      </div>
    </div>

    <div class="main-content">
      <div>
        <h2 class="section-title">Status dos Sensores</h2>
        <div class="status-grid">
          <div class="status-item">
            <div class="status-item-header">
              <i class="fas fa-water icon"></i>
              <strong>Nível de Água:</strong>
            </div>
            <span id="waterLevel" class="status-value">N/A %</span>
          </div>
          <div id="soilMoistureCard" class="status-item">
            <div class="status-item-header">
              <i class="fas fa-tint icon"></i>
              <strong>Umidade do Solo:</strong>
            </div>
            <span id="humidity" class="status-value">N/A %</span>
            <div class="status-item-subsection">
              <i class="fas fa-leaf icon-subsection"></i>
              <span>Estado: </span><span id="humidityState">N/A</span>
            </div>
          </div>
          <div id="pumpStatusItem" class="status-item">
            <div class="status-item-header">
              <i class="fas fa-faucet icon"></i>
              <strong>Bomba:</strong>
            </div>
            <span id="pumpState" class="status-value">N/A</span>
          </div>
          <div id="autoModeStatusItem" class="status-item">
            <div class="status-item-header">
              <i class="fas fa-robot icon"></i>
              <strong>Modo Automático:</strong>
            </div>
            <span id="autoMode" class="status-value">N/A</span>
          </div>
        </div>
      </div>
      <div>
        <div class="controls">
          <h2 class="section-title">Controles Manuais & Modo</h2>
          <div class="control-group">
            <h3><i class="fas fa-cogs"></i> Modo Automático</h3>
            <div class="button-group">
              <button id="autoOnBtn" class="mode on"><i class="fas fa-brain"></i>LIGAR</button>
              <button id="autoOffBtn" class="mode off"><i class="fas fa-ban"></i>DESLIGAR</button>
            </div>
          </div>
          <div class="control-group">
            <h3><i class="fas fa-hand-paper"></i> Bomba de Água (Manual)</h3>
            <div class="button-group">
              <button id="pumpOnBtn" class="on"><i class="fas fa-power-off"></i>LIGAR</button>
              <button id="pumpOffBtn" class="off"><i class="fas fa-power-off"></i>DESLIGAR</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ATENÇÃO: Senha fixa no cliente NÃO É SEGURO para produção!
    // Gere o hash de sua senha (ex: "hf1234") em: https://emn178.github.io/online-tools/sha256.html
    const ADMIN_PASSWORD_TARGET_HASH = "cc470b598a335f1db970be6c6c5c58498ae4cfdb6c9d66de1d06cae04381a900"; // SUBSTITUA ESTE HASH

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const MQTT_BROKER_WEBSOCKET = "wss://broker.emqx.io:8084/mqtt";
    const MQTT_CLIENT_ID_WEB = "hidroflow_web_client_" + Math.random().toString(16).substr(2, 8);
    const UNIQUE_TOPIC_PREFIX_WEB = "hidroflow/seu_id_unico"; // ATENÇÃO: Substitua
    const TOPIC_SUB_DATA = UNIQUE_TOPIC_PREFIX_WEB + "/data";
    const TOPIC_PUB_PUMP_COMMAND = UNIQUE_TOPIC_PREFIX_WEB + "/commands/pump";
    const TOPIC_PUB_MODE_COMMAND = UNIQUE_TOPIC_PREFIX_WEB + "/commands/mode";
    const TOPIC_SUB_ESP_STATUS = UNIQUE_TOPIC_PREFIX_WEB + "/status";
    const MAX_HUMIDITY_RAW_VALUE = 4095;
    const MAX_WATER_LEVEL_RAW_VALUE = 900;

    let client = null;
    let isAutoModeActive = false;
    let currentUserRole = 'guest';

    const authScreen = document.getElementById('authScreen');
    const mainPanelContainer = document.querySelector('.container');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const guestLoginBtn = document.getElementById('guestLoginBtn');
    const passwordForm = document.querySelector('.password-form');
    const passwordInput = document.getElementById('passwordInput');
    const submitPasswordBtn = document.getElementById('submitPasswordBtn');
    const authMessage = document.getElementById('authMessage');
    const panelActionButton = document.getElementById('panelActionButton'); // Renomeado

    const mqttStatusElem = document.getElementById('mqttStatus').querySelector('span');
    const mqttStatusIconElem = document.getElementById('mqttStatus').querySelector('i');
    const mqttStatusContainer = document.getElementById('mqttStatus');
    const espStatusElem = document.getElementById('espStatus').querySelector('span');
    const espStatusIconElem = document.getElementById('espStatus').querySelector('i');
    const espStatusContainer = document.getElementById('espStatus');
    const waterLevelElem = document.getElementById('waterLevel');
    const humidityElem = document.getElementById('humidity');
    const humidityStateElem = document.getElementById('humidityState');
    const soilMoistureCardElem = document.getElementById('soilMoistureCard');
    const pumpStateElem = document.getElementById('pumpState');
    const autoModeElem = document.getElementById('autoMode');
    const pumpStatusItem = document.getElementById('pumpStatusItem');
    const autoModeStatusItem = document.getElementById('autoModeStatusItem');
    const pumpOnBtn = document.getElementById('pumpOnBtn');
    const pumpOffBtn = document.getElementById('pumpOffBtn');
    const autoOnBtn = document.getElementById('autoOnBtn');
    const autoOffBtn = document.getElementById('autoOffBtn');
    const controlButtons = [pumpOnBtn, pumpOffBtn, autoOnBtn, autoOffBtn];

    function updatePanelActionButton() {
      panelActionButton.innerHTML = ''; // Limpa conteúdo anterior
      panelActionButton.onclick = null; // Remove listener anterior

      if (currentUserRole === 'admin') {
        panelActionButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sair';
        panelActionButton.title = "Sair do modo administrador";
        panelActionButton.style.display = 'inline-flex';
        panelActionButton.onclick = handleLogout;
        panelActionButton.classList.remove('guest-login-btn'); // Garante que não tenha classe de guest
        panelActionButton.classList.add('logoutButton'); // Adiciona classe de logout (para estilização se necessário)
      } else if (currentUserRole === 'guest') {
        panelActionButton.innerHTML = '<i class="fas fa-user-shield"></i> Login Admin';
        panelActionButton.title = "Tentar login como Administrador";
        panelActionButton.style.display = 'inline-flex';
        panelActionButton.onclick = promptAdminLoginFromGuestView;
        panelActionButton.classList.remove('logoutButton');
        panelActionButton.classList.add('guest-login-btn'); // Para estilização se necessário (ex: cor primária)
      } else {
        panelActionButton.style.display = 'none';
      }
    }


    function setPanelAccess(role) {
      currentUserRole = role;
      localStorage.setItem('hidroflowUserRole', role);
      updatePanelActionButton(); // Atualiza o botão de ação do painel

      if (role === 'admin') {
        authScreen.style.display = 'none';
        mainPanelContainer.style.display = 'block';
        controlButtons.forEach(btn => btn.disabled = false);
        if (!client || !client.isConnected()) { connectMQTT(); }
        updateButtonStates(pumpStateElem.textContent, autoModeElem.textContent);
      } else { // 'guest'
        authScreen.style.display = 'none';
        mainPanelContainer.style.display = 'block';
        controlButtons.forEach(btn => btn.disabled = true);
        if (!client || !client.isConnected()) { connectMQTT(); }
      }
      passwordInput.value = '';
      authMessage.textContent = '';
    }

    function resetToAuthScreen() {
      mainPanelContainer.style.display = 'none';
      panelActionButton.style.display = 'none';
      authScreen.style.display = 'block';
      passwordForm.style.display = 'none';
      authMessage.textContent = '';
      if (client && client.isConnected()) {
        try { client.disconnect(); } catch (e) { console.warn("MQTT já desconectado ou erro:", e); }
        client = null;
        mqttStatusElem.textContent = "Desconectado"; // Simplificado
        mqttStatusContainer.className = 'disconnected';
        mqttStatusIconElem.className = 'fas fa-wifi';
      }
    }

    function handleLogout() {
      localStorage.removeItem('hidroflowUserRole');
      currentUserRole = 'guest'; // Volta para guest por padrão
      resetToAuthScreen();
    }

    function promptAdminLoginFromGuestView() {
      // Essencialmente o mesmo que logout, mas o usuário já é guest
      currentUserRole = 'guest'; // Garante que está como guest
      localStorage.removeItem('hidroflowUserRole'); // Limpa qualquer resquício
      resetToAuthScreen();
    }


    adminLoginBtn.addEventListener('click', () => {
      passwordForm.style.display = 'block';
      passwordInput.focus();
      authMessage.textContent = '';
    });
    guestLoginBtn.addEventListener('click', () => { setPanelAccess('guest'); });

    submitPasswordBtn.addEventListener('click', async () => {
      const enteredPassword = passwordInput.value;
      if (!ADMIN_PASSWORD_TARGET_HASH) {
        authMessage.textContent = "ERRO: Hash da senha não configurado no código!";
        console.error("Configure ADMIN_PASSWORD_TARGET_HASH no script.");
        return;
      }
      if (!enteredPassword) { authMessage.textContent = 'Por favor, digite a senha.'; return; }
      const enteredPasswordHash = await sha256(enteredPassword);
      if (enteredPasswordHash === ADMIN_PASSWORD_TARGET_HASH) {
        authMessage.textContent = '';
        setPanelAccess('admin');
      } else {
        authMessage.textContent = 'Senha incorreta. Tente novamente.';
        passwordInput.value = ''; passwordInput.focus();
      }
    });
    passwordInput.addEventListener('keypress', (event) => { if (event.key === "Enter") { event.preventDefault(); submitPasswordBtn.click(); } });

    // Event listener para o botão de ação do painel é atribuído em updatePanelActionButton

    function updateStatusItemVisuals(itemElement, state, onClass, offClass, neutralClass = null) { /* ... (sem mudanças) ... */
      itemElement.classList.remove(onClass, offClass);
      if (neutralClass) itemElement.classList.remove(neutralClass);
      const normalizedState = typeof state === 'string' ? state.toLowerCase() : 'n/a';
      if (normalizedState === 'ligada' || normalizedState === 'ativado') { itemElement.classList.add(onClass); }
      else if (normalizedState === 'desligada' || normalizedState === 'desativado') { itemElement.classList.add(offClass); }
      else if (neutralClass && (normalizedState === 'n/a' || normalizedState === '' || state === undefined || state === null)) { itemElement.classList.add(neutralClass); }
    }
    function updateSoilMoistureCardVisuals(cardElement, humidityStateText) { /* ... (sem mudanças) ... */
      cardElement.classList.remove('soil-dry', 'soil-humid', 'soil-wet');
      const normalizedState = typeof humidityStateText === 'string' ? humidityStateText.toLowerCase() : 'n/a';
      if (normalizedState === 'seco') { cardElement.classList.add('soil-dry'); }
      else if (normalizedState === 'úmido') { cardElement.classList.add('soil-humid'); }
      else if (normalizedState === 'molhado') { cardElement.classList.add('soil-wet'); }
    }
    function updateButtonStates(pumpState, autoMode) { /* ... (sem mudanças na lógica interna, mas agora respeita currentUserRole) ... */
      const isAdmin = currentUserRole === 'admin';
      pumpOnBtn.classList.remove('selected', 'inactive'); pumpOffBtn.classList.remove('selected', 'inactive');
      if (!isAdmin || autoMode === 'Ativado') {
        pumpOnBtn.disabled = true; pumpOffBtn.disabled = true;
        pumpOnBtn.classList.add('inactive'); pumpOffBtn.classList.add('inactive');
      } else {
        pumpOnBtn.disabled = false; pumpOffBtn.disabled = false;
        if (pumpState === 'Ligada') { pumpOnBtn.classList.add('selected'); pumpOffBtn.classList.add('inactive'); }
        else if (pumpState === 'Desligada') { pumpOffBtn.classList.add('selected'); pumpOnBtn.classList.add('inactive'); }
        else { pumpOnBtn.classList.add('inactive'); pumpOffBtn.classList.add('inactive'); }
      }
      autoOnBtn.classList.remove('selected', 'inactive'); autoOffBtn.classList.remove('selected', 'inactive');
      if (!isAdmin) {
        autoOnBtn.disabled = true; autoOffBtn.disabled = true;
        autoOnBtn.classList.add('inactive'); autoOffBtn.classList.add('inactive');
      } else {
        autoOnBtn.disabled = false; autoOffBtn.disabled = false;
        if (autoMode === 'Ativado') { autoOnBtn.classList.add('selected'); autoOffBtn.classList.add('inactive'); }
        else if (autoMode === 'Desativado') { autoOffBtn.classList.add('selected'); autoOnBtn.classList.add('inactive'); }
        else { autoOnBtn.classList.add('inactive'); autoOffBtn.classList.add('inactive'); }
      }
      updateStatusItemVisuals(pumpStatusItem, pumpState, 'pump-on', 'pump-off', 'pump-neutral');
      updateStatusItemVisuals(autoModeStatusItem, autoMode, 'auto-mode-on', 'auto-mode-off', 'auto-mode-neutral');
    }
    function connectMQTT() { /* ... (sem mudanças significativas, exceto a checagem inicial) ... */
      if (client && client.isConnected()) { console.log("MQTT já conectado."); return; }
      client = new Paho.MQTT.Client(MQTT_BROKER_WEBSOCKET, MQTT_CLIENT_ID_WEB);
      client.onConnectionLost = function (responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Conexão MQTT perdida: " + responseObject.errorMessage);
          mqttStatusElem.textContent = "Conexão Perdida..."; // Mais curto
          mqttStatusContainer.className = 'disconnected'; mqttStatusIconElem.className = 'fas fa-times-circle';
          setTimeout(connectMQTT, 5000);
        }
      };
      client.onMessageArrived = function (message) {
        const topic = message.destinationName; const payload = message.payloadString;
        if (topic === TOPIC_SUB_DATA) {
          try {
            const data = JSON.parse(payload);
            const rawWaterLevel = data.water_level;
            if (rawWaterLevel !== undefined) { const pWL = (parseFloat(rawWaterLevel) / MAX_WATER_LEVEL_RAW_VALUE) * 100; waterLevelElem.textContent = Math.max(0, Math.min(100, pWL)).toFixed(1) + "%"; } else { waterLevelElem.textContent = 'N/A %'; }
            const rawHumidity = data.humidity;
            if (rawHumidity !== undefined) { const pH = (parseFloat(rawHumidity) / MAX_HUMIDITY_RAW_VALUE) * 100; humidityElem.textContent = Math.max(0, Math.min(100, pH)).toFixed(1) + "%"; } else { humidityElem.textContent = 'N/A %'; }
            const currentHumidityState = data.humidity_state || 'N/A';
            humidityStateElem.textContent = currentHumidityState; updateSoilMoistureCardVisuals(soilMoistureCardElem, currentHumidityState);
            pumpStateElem.textContent = data.pump_state || 'N/A'; autoModeElem.textContent = data.auto_mode || 'N/A';
            isAutoModeActive = (data.auto_mode === 'Ativado');
            updateButtonStates(data.pump_state, data.auto_mode);
          } catch (e) { console.error("Erro JSON:", e); /* ... (mensagens de erro nos elementos) ... */ }
        } else if (topic === TOPIC_SUB_ESP_STATUS) {
          espStatusElem.textContent = payload;
          if (payload.toLowerCase().includes("online")) { espStatusContainer.className = 'esp-online'; espStatusIconElem.className = 'fas fa-check-circle'; }
          else if (payload.toLowerCase().includes("offline")) { espStatusContainer.className = 'esp-offline'; espStatusIconElem.className = 'fas fa-times-circle'; }
          else { espStatusContainer.className = 'esp-loading'; espStatusIconElem.className = 'fas fa-spinner fa-spin'; }
        }
      };
      client.connect({
        onSuccess: function () {
          console.log("MQTT Conectado!"); mqttStatusElem.textContent = "Broker"; mqttStatusContainer.className = 'connected'; mqttStatusIconElem.className = 'fas fa-check-circle';
          client.subscribe(TOPIC_SUB_DATA); client.subscribe(TOPIC_SUB_ESP_STATUS);
        },
        onFailure: function (message) {
          console.log("Falha MQTT: " + message.errorMessage); mqttStatusElem.textContent = "Falha MQTT"; mqttStatusContainer.className = 'disconnected'; mqttStatusIconElem.className = 'fas fa-exclamation-triangle';
          setTimeout(connectMQTT, 5000);
        },
        useSSL: MQTT_BROKER_WEBSOCKET.startsWith("wss"), timeout: 5, keepAliveInterval: 60
      });
    }
    function publishCommand(topic, messagePayload) { /* ... (lógica de checagem de admin já está aqui) ... */
      if (currentUserRole !== 'admin') {
        console.warn("Ação não permitida."); authMessage.textContent = "Acesso restrito a administradores.";
        // Se o painel estiver visível e o usuário não for admin (ex: localStorage manipulado),
        // podemos forçar o logout para revalidar.
        if (mainPanelContainer.style.display === 'block') {
          // handleLogout(); // Descomente se quiser forçar logout imediato em tentativa de ação não permitida
        }
        return;
      }
      if (client && client.isConnected()) {
        const message = new Paho.MQTT.Message(messagePayload); message.destinationName = topic; message.qos = 1; message.retained = false;
        client.send(message); console.log(`Comando: ${topic}, ${messagePayload}`); authMessage.textContent = '';
      } else {
        console.error("MQTT não conectado."); mqttStatusElem.textContent = "Não conectado"; mqttStatusContainer.className = 'disconnected'; mqttStatusIconElem.className = 'fas fa-exclamation-triangle';
      }
    }
    pumpOnBtn.addEventListener('click', function () { if (currentUserRole === 'admin' && !isAutoModeActive) { publishCommand(TOPIC_PUB_PUMP_COMMAND, "ON"); } else if (currentUserRole !== 'admin') { publishCommand("", ""); } });
    pumpOffBtn.addEventListener('click', function () { if (currentUserRole === 'admin' && !isAutoModeActive) { publishCommand(TOPIC_PUB_PUMP_COMMAND, "OFF"); } else if (currentUserRole !== 'admin') { publishCommand("", ""); } });
    autoOnBtn.addEventListener('click', function () { if (currentUserRole === 'admin') { publishCommand(TOPIC_PUB_MODE_COMMAND, "AUTO_ON"); } else { publishCommand("", ""); } });
    autoOffBtn.addEventListener('click', function () { if (currentUserRole === 'admin') { publishCommand(TOPIC_PUB_MODE_COMMAND, "AUTO_OFF"); } else { publishCommand("", ""); } });

    document.addEventListener('DOMContentLoaded', function () {
      espStatusElem.textContent = "Aguardando ESP32...";
      espStatusContainer.className = 'esp-loading'; espStatusIconElem.className = 'fas fa-spinner fa-spin';
      waterLevelElem.textContent = 'N/A %'; humidityElem.textContent = 'N/A %'; humidityStateElem.textContent = 'N/A'; pumpStateElem.textContent = 'N/A'; autoModeElem.textContent = 'N/A';

      const storedRole = localStorage.getItem('hidroflowUserRole');

      if (storedRole) {
        setPanelAccess(storedRole);
      } else {
        authScreen.style.display = 'block';
        mainPanelContainer.style.display = 'none';
        updatePanelActionButton(); // Garante que o botão de ação do painel esteja oculto
      }
      if (mainPanelContainer.style.display === 'block') {
        updateButtonStates('N/A', 'N/A');
        updateSoilMoistureCardVisuals(soilMoistureCardElem, 'N/A');
      }
    });
  </script>
</body>

</html>