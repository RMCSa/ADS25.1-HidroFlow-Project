<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HidroFlow - Painel de Irrigação</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f4f8; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; font-size: 2em; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .status-item { background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 5px solid #3498db; }
        .status-item strong { display: block; margin-bottom: 8px; color: #3498db; font-size: 1.1em; }
        .status-item span { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        .controls { text-align: center; margin-top: 20px; }
        .control-group { margin-bottom: 25px; padding: 15px; background-color: #ecf0f1; border-radius: 8px; }
        .control-group h3 { margin-top: 0; margin-bottom: 15px; color: #7f8c8d; font-size: 1.3em; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 25px; text-align: center; text-decoration: none; display: inline-block; font-size: 1em; margin: 5px; cursor: pointer; border-radius: 6px; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:hover { background-color: #2980b9; }
        button:active { transform: scale(0.98); }
        button.on { background-color: #2ecc71; }
        button.on:hover { background-color: #27ae60; }
        button.off { background-color: #e74c3c; }
        button.off:hover { background-color: #c0392b; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #mqttStatus { font-weight: bold; padding: 10px; border-radius: 5px; margin-bottom:20px; text-align: center; }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .esp-status { font-style: italic; color: #555; margin-top: 10px; text-align: center; }

        /* Estilos para botões selecionados */
        button.selected {
            box-shadow: 0 0 0 3px #2222ff66; /* Destaque azul */
            filter: brightness(1.1);
        }
        button.inactive {
            background-color: #95a5a6 !important; /* Cinza para inativo */
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HidroFlow - Painel de Irrigação</h1>
        <div id="mqttStatus" class="disconnected">Desconectado do Broker MQTT</div>
        <div id="espStatus" class="esp-status">Aguardando status do ESP32...</div>

        <div class="status-grid">
            <div class="status-item">
                <strong>Nível de Água:</strong>
                <span id="waterLevel">N/A</span>
            </div>
            <div class="status-item">
                <strong>Umidade do Solo:</strong>
                <span id="humidity">N/A</span>
            </div>
            <div class="status-item">
                <strong>Estado do Solo:</strong>
                <span id="humidityState">N/A</span>
            </div>
            <div class="status-item">
                <strong>Bomba:</strong>
                <span id="pumpState">N/A</span>
            </div>
            <div class="status-item">
                <strong>Modo Automático:</strong>
                <span id="autoMode">N/A</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Bomba de Água (Manual)</h3>
                <button id="pumpOnBtn" class="on">LIGAR BOMBA</button>
                <button id="pumpOffBtn" class="off">DESLIGAR BOMBA</button>
            </div>
            <div class="control-group">
                <h3>Modo de Operação</h3>
                <button id="autoOnBtn" class="on">LIGAR AUTOMÁTICO</button>
                <button id="autoOffBtn" class="off">DESLIGAR AUTOMÁTICO</button>
            </div>
        </div>
    </div>

    <script>
        // === Configurações MQTT (PAINEL WEB) ===
        const MQTT_BROKER_WEBSOCKET = "ws://broker.emqx.io:8083/mqtt"; // WebSocket não seguro
        // const MQTT_BROKER_WEBSOCKET = "wss://broker.emqx.io:8084/mqtt"; // WebSocket seguro (recomendado se tiver certificado)
        const MQTT_CLIENT_ID_WEB = "hidroflow_web_client_" + Math.random().toString(16).substr(2, 8); // ID de cliente aleatório para o painel

        // Tópicos MQTT (DEVEM CORRESPONDER AOS DO ESP32)
        // IMPORTANTE: Substitua 'seu_id_unico' pelo mesmo que você usou no ESP32!
        const UNIQUE_TOPIC_PREFIX_WEB = "hidroflow/seu_id_unico"; // Ex: hidroflow/joao_silva_123
        const TOPIC_SUB_DATA = UNIQUE_TOPIC_PREFIX_WEB + "/data";
        const TOPIC_PUB_PUMP_COMMAND = UNIQUE_TOPIC_PREFIX_WEB + "/commands/pump";
        const TOPIC_PUB_MODE_COMMAND = UNIQUE_TOPIC_PREFIX_WEB + "/commands/mode";
        const TOPIC_SUB_ESP_STATUS = UNIQUE_TOPIC_PREFIX_WEB + "/status";

        let client = null;
        let isAutoModeActive = false; // Para controlar a ativação dos botões manuais

        // Elementos da UI
        const mqttStatusElem = document.getElementById('mqttStatus');
        const espStatusElem = document.getElementById('espStatus');
        const waterLevelElem = document.getElementById('waterLevel');
        const humidityElem = document.getElementById('humidity');
        const humidityStateElem = document.getElementById('humidityState');
        const pumpStateElem = document.getElementById('pumpState');
        const autoModeElem = document.getElementById('autoMode');

        const pumpOnBtn = document.getElementById('pumpOnBtn');
        const pumpOffBtn = document.getElementById('pumpOffBtn');
        const autoOnBtn = document.getElementById('autoOnBtn');
        const autoOffBtn = document.getElementById('autoOffBtn');

        function updateButtonStates(pumpState, autoMode) {
            // Botões da Bomba
            pumpOnBtn.classList.remove('selected', 'inactive');
            pumpOffBtn.classList.remove('selected', 'inactive');

            if (autoMode === 'Ativado') {
                pumpOnBtn.disabled = true;
                pumpOffBtn.disabled = true;
                pumpOnBtn.classList.add('inactive');
                pumpOffBtn.classList.add('inactive');
            } else {
                pumpOnBtn.disabled = false;
                pumpOffBtn.disabled = false;
                if (pumpState === 'Ligada') {
                    pumpOnBtn.classList.add('selected');
                    pumpOffBtn.classList.add('inactive');
                } else if (pumpState === 'Desligada') {
                    pumpOffBtn.classList.add('selected');
                    pumpOnBtn.classList.add('inactive');
                } else { // Estado indefinido ou N/A
                    pumpOnBtn.classList.add('inactive');
                    pumpOffBtn.classList.add('inactive');
                }
            }

            // Botões do Modo Automático
            autoOnBtn.classList.remove('selected', 'inactive');
            autoOffBtn.classList.remove('selected', 'inactive');
            if (autoMode === 'Ativado') {
                autoOnBtn.classList.add('selected');
                autoOffBtn.classList.add('inactive');
            } else if (autoMode === 'Desativado') {
                autoOffBtn.classList.add('selected');
                autoOnBtn.classList.add('inactive');
            } else { // Estado indefinido ou N/A
                autoOnBtn.classList.add('inactive');
                autoOffBtn.classList.add('inactive');
            }
        }


        function connectMQTT() {
            client = new Paho.MQTT.Client(MQTT_BROKER_WEBSOCKET, MQTT_CLIENT_ID_WEB);

            client.onConnectionLost = function (responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("Conexão MQTT perdida: " + responseObject.errorMessage);
                    mqttStatusElem.textContent = "Conexão Perdida. Tentando reconectar...";
                    mqttStatusElem.className = 'disconnected';
                    // Tentar reconectar após um tempo
                    setTimeout(connectMQTT, 5000);
                }
            };

            client.onMessageArrived = function (message) {
                console.log("Mensagem recebida: Tópico=" + message.destinationName + ", Payload=" + message.payloadString);
                const topic = message.destinationName;
                const payload = message.payloadString;

                if (topic === TOPIC_SUB_DATA) {
                    try {
                        const data = JSON.parse(payload);
                        waterLevelElem.textContent = data.water_level !== undefined ? data.water_level : 'N/A';
                        humidityElem.textContent = data.humidity !== undefined ? data.humidity : 'N/A';
                        humidityStateElem.textContent = data.humidity_state || 'N/A';
                        pumpStateElem.textContent = data.pump_state || 'N/A';
                        autoModeElem.textContent = data.auto_mode || 'N/A';
                        
                        isAutoModeActive = (data.auto_mode === 'Ativado');
                        updateButtonStates(data.pump_state, data.auto_mode);

                    } catch (e) {
                        console.error("Erro ao processar JSON de dados:", e);
                    }
                } else if (topic === TOPIC_SUB_ESP_STATUS) {
                    espStatusElem.textContent = "ESP32: " + payload;
                }
            };

            client.connect({
                onSuccess: function () {
                    console.log("Conectado ao Broker MQTT via WebSocket!");
                    mqttStatusElem.textContent = "Conectado ao Broker MQTT";
                    mqttStatusElem.className = 'connected';
                    
                    // Se inscrever nos tópicos após a conexão
                    client.subscribe(TOPIC_SUB_DATA);
                    console.log("Inscrito em: " + TOPIC_SUB_DATA);
                    client.subscribe(TOPIC_SUB_ESP_STATUS);
                    console.log("Inscrito em: " + TOPIC_SUB_ESP_STATUS);

                    // Solicitar dados iniciais (opcional, o ESP32 já publica periodicamente)
                    // publishCommand(TOPIC_PUB_MODE_COMMAND, "GET_STATUS"); // Exemplo, se o ESP32 suportasse isso
                },
                onFailure: function (message) {
                    console.log("Falha na conexão MQTT: " + message.errorMessage);
                    mqttStatusElem.textContent = "Falha na conexão MQTT: " + message.errorMessage;
                    mqttStatusElem.className = 'disconnected';
                     // Tentar reconectar após um tempo
                    setTimeout(connectMQTT, 5000);
                },
                useSSL: MQTT_BROKER_WEBSOCKET.startsWith("wss"), // Habilita SSL se estiver usando wss
                timeout: 5, // Tempo limite de conexão em segundos
                keepAliveInterval: 60 // Intervalo de keep alive em segundos
            });
        }

        function publishCommand(topic, messagePayload) {
            if (client && client.isConnected()) {
                const message = new Paho.MQTT.Message(messagePayload);
                message.destinationName = topic;
                message.qos = 0; // QoS 0 é suficiente para comandos
                message.retained = false;
                client.send(message);
                console.log(`Comando enviado - Tópico: ${topic}, Mensagem: ${messagePayload}`);
            } else {
                console.error("Não conectado ao MQTT. Não é possível enviar comando.");
                mqttStatusElem.textContent = "Não conectado. Envio de comando falhou.";
                mqttStatusElem.className = 'disconnected';
            }
        }

        // Event Listeners para os botões
        pumpOnBtn.addEventListener('click', function() {
            if (!isAutoModeActive) {
                publishCommand(TOPIC_PUB_PUMP_COMMAND, "ON");
            }
        });

        pumpOffBtn.addEventListener('click', function() {
            if (!isAutoModeActive) {
                publishCommand(TOPIC_PUB_PUMP_COMMAND, "OFF");
            }
        });

        autoOnBtn.addEventListener('click', function() {
            publishCommand(TOPIC_PUB_MODE_COMMAND, "AUTO_ON");
        });

        autoOffBtn.addEventListener('click', function() {
            publishCommand(TOPIC_PUB_MODE_COMMAND, "AUTO_OFF");
        });
        
        // Iniciar a conexão MQTT quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            connectMQTT();
            // Inicializa os botões com um estado padrão
            updateButtonStates('N/A', 'N/A');
        });

    </script>
</body>
</html>